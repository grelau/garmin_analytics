<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Garmin Analytics</title>

    <!-- FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>


    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
        }
        .layout {
            display: flex;
            align-items: flex-start;
            gap: 40px;
        }

        #chart_container {
            width: 350px;
            height: 350px;
        }
        #calendar {
            flex: 1;
        }
    </style>
</head>
<body>

<h1>Garmin Analytics</h1>

<div class="layout">
    <div id="calendar"></div>
    <div id="chart_container">
        <canvas id="hrPie"></canvas>
        <div id="stats">
            <p><strong>Volume :</strong></p>
            <p>üìÖ Activit√©s : <span id="total-activities">‚Äì</span></p>
            <p>‚è± Temps : <span id="total-duration">‚Äì</span></p>
            <p>üèÉ Distance : <span id="total-distance">‚Äì</span> km</p>
            <p>‚õ∞Ô∏è D+ : <span id="total-elevation-gain">‚Äì</span></p>
        </div>

    </div>
</div>

<script>
/* 1Ô∏è‚É£ Variables globales */
let pieChart;

/* 2Ô∏è‚É£ Fonctions utilitaires */
function fetchHrZones(start, end) {
    console.log("fetchHrZones appel√©e", start, end);
    fetch(`/api/hr-zones?start=${start}&end=${end}`)
        .then(res => res.json())
        .then(data => updatePieChart(data));
}

function getTotalVolume(start, end) {
    console.log("getTotalVolume appel√©e", start, end);
    fetch(`/api/total-volume?start=${start}&end=${end}`)
        .then(res => res.json())
        .then(data => {
            document.getElementById("total-activities").textContent = data.total_activities;
            document.getElementById("total-distance").textContent = data.total_distance;
            document.getElementById("total-duration").textContent = data.total_duration;
            document.getElementById("total-elevation-gain").textContent = data.total_elevation_gain;
        });
}

function updatePieChart(zones) {
    console.log(zones);
    const data = [
        zones.z1,
        zones.z2,
        zones.z3,
        zones.z4,
        zones.z5
    ];

    if (pieChart) {
        pieChart.data.datasets[0].data = data;
        pieChart.update();
        return;
    }

    pieChart = new Chart(document.getElementById("hrPie"), {
        type: "pie",
        data: {
            labels: ["Z1", "Z2", "Z3", "Z4", "Z5"],
            datasets: [{
                data: data,
                backgroundColor: [
                    "#9e9e9e",
                    "#2196f3",
                    "#4caf50",
                    "#ff9800",
                    "#f44336"
                ]
            }]
        },
        options: {
            plugins: {
                datalabels: {
                    color: "#fff",
                    font: {
                        weight: "bold",
                        size: 14
                    },
                    align: "end",
                    offset: 16,  
                    formatter: (value, context) => {
                        const dataArr = context.chart.data.datasets[0].data;
                        const total = dataArr.reduce((a, b) => a + b, 0);
                        if (!total || value === 0) return "";
                        const percent = (value / total * 100).toFixed(1);
                        return `${percent}%`;
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percent = total ? ((value / total) * 100).toFixed(1) : 0;
                            return `${context.label}: ${percent}%`;
                        }
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}
document.addEventListener('DOMContentLoaded', function() {

    const calendar = new FullCalendar.Calendar(
        document.getElementById('calendar'),
        {
            initialView: 'dayGridMonth',
            events: '/api/activities',
            datesSet: function(info) {
                fetchHrZones(info.startStr, info.endStr);
                getTotalVolume(info.startStr, info.endStr);
            },
            eventContent: function(arg) {
                const d = arg.event.extendedProps;

                return {
                    html: `
                        <div>
                            <strong>${arg.event.title}</strong><br>
                            ${(d.distance / 1000).toFixed(1)} km<br>
                            ${d.duration_min} min
                        </div>
                    `
                };
            }
        }
    );
    console.log('coucou JS')
    calendar.render();
});
</script>


</body>
</html>
